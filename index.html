<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ğŸ’° ë¶ìœ ëŸ½ íƒë°© ê³µë™ê²½ë¹„</title>
<style>
:root {
  --bg:#0f1117;--surface:#1a1d27;--surface2:#242836;--border:#2e3345;
  --text:#e8eaf0;--text2:#9498a8;--accent:#4a9eff;--accent2:#3a7fd4;
  --green:#34d399;--red:#f87171;--orange:#fbbf24;--yellow:#facc15;
  --purple:#a78bfa;--radius:12px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,'Apple SD Gothic Neo','Malgun Gothic',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:20px;font-size:15px;line-height:1.5}
button,input,select,textarea{font-family:inherit;font-size:inherit;color:var(--text);border:none;outline:none;background:none}
input[type="number"]{-moz-appearance:textfield}
input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none}

.header{position:sticky;top:0;z-index:100;background:rgba(15,17,23,0.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);padding:14px 16px;display:flex;justify-content:space-between;align-items:center}
.header h1{font-size:17px;font-weight:700;letter-spacing:-0.3px}
.header button{width:36px;height:36px;border-radius:50%;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer}

.balance-card{margin:12px 16px;padding:18px;background:linear-gradient(135deg,#1e2a4a,#1a2040);border-radius:var(--radius);border:1px solid #2a3560}
.bl{font-size:11px;color:var(--text2);letter-spacing:0.3px}
.balance-big{font-size:26px;font-weight:800;letter-spacing:-1px;font-variant-numeric:tabular-nums;margin:2px 0}
.balance-big.pos{color:var(--green)}.balance-big.neg{color:var(--red)}
.balance-row{display:flex;flex-wrap:wrap;gap:6px 10px;margin-top:12px}
.balance-item{min-width:calc(33% - 10px);flex:1}
.balance-item .v{font-size:13px;font-weight:700;font-variant-numeric:tabular-nums}
.cur-balance-section{margin-top:12px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.08)}
.cur-bal-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0}
.cur-bal-label{font-size:12px;color:var(--text2)}
.cur-bal-spent{font-size:12px;font-weight:600;font-variant-numeric:tabular-nums}
.cur-bal-krw{font-size:11px;color:var(--text2);font-variant-numeric:tabular-nums}

.today-banner{margin:0 16px 8px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.today-banner .v{font-size:15px;font-weight:700}

.tab-nav{display:flex;gap:4px;margin:0 16px;padding:3px;background:var(--surface);border-radius:10px}
.tab-btn{flex:1;padding:9px 0;text-align:center;font-size:13px;font-weight:600;border-radius:8px;cursor:pointer;transition:all 0.2s;color:var(--text2)}
.tab-btn.active{background:var(--accent);color:#fff}

.panel{display:none;padding:12px 16px}.panel.active{display:block}

.fg{margin-bottom:12px}
.fl{display:block;font-size:12px;color:var(--text2);margin-bottom:5px;font-weight:600}
.fi{width:100%;padding:11px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;font-size:15px;color:var(--text);transition:border-color 0.2s}
.fi:focus{border-color:var(--accent)}.fi::placeholder{color:#555a6e}
.frow{display:flex;gap:10px}.frow>.fg{flex:1}
.chip-group{display:flex;flex-wrap:wrap;gap:6px}
.chip{padding:7px 14px;border-radius:20px;font-size:13px;font-weight:500;background:var(--surface2);border:1px solid var(--border);cursor:pointer;transition:all 0.15s;white-space:nowrap}
.chip.active{background:var(--accent);border-color:var(--accent);color:#fff}
.custom-input-wrap{display:none;margin-top:6px}.custom-input-wrap.show{display:block}
.time-row{display:flex;gap:6px;align-items:center}
.time-field{width:60px;padding:11px 8px;text-align:center;background:var(--surface2);border:1px solid var(--border);border-radius:10px;font-size:17px;font-weight:600;color:var(--text)}
.time-field:focus{border-color:var(--accent)}
.time-sep{font-size:20px;font-weight:700;color:var(--text2)}
.amount-wrap{position:relative;display:flex;align-items:center}
.amount-wrap .tag{position:absolute;right:12px;font-size:12px;color:var(--text2);font-weight:600;pointer-events:none}
.btn-primary{width:100%;padding:14px;margin-top:8px;background:var(--accent);border-radius:10px;font-size:15px;font-weight:700;color:#fff;cursor:pointer;transition:background 0.15s}
.btn-primary:active{background:var(--accent2)}

.photo-area{margin-top:6px}
.photo-btn{display:inline-flex;align-items:center;gap:6px;padding:10px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;cursor:pointer;font-size:13px;font-weight:600;color:var(--text2);transition:border-color 0.15s}
.photo-btn:active{border-color:var(--accent)}
.photo-preview{margin-top:8px;position:relative;display:none}
.photo-preview.show{display:inline-block}
.photo-preview img{width:120px;height:90px;object-fit:cover;border-radius:8px;border:1px solid var(--border)}
.photo-remove{position:absolute;top:-6px;right:-6px;width:22px;height:22px;border-radius:50%;background:var(--red);color:#fff;font-size:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:700}

.filter-bar{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-bottom:10px;transition:border-color 0.2s}
.filter-bar.has-filter{border-color:rgba(74,158,255,0.3)}
.filter-row{display:flex;gap:8px;margin-bottom:8px}.filter-row:last-child{margin-bottom:0}
.filter-row .fi{font-size:13px;padding:8px 10px}
.filter-actions{display:flex;gap:8px;margin-top:10px}
.btn-sm{padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.15s}
.btn-filter{background:var(--accent);color:#fff}
.btn-reset{background:var(--surface2);color:var(--text2);border:1px solid var(--border)}
.btn-export{background:#1a3a2a;color:var(--green);border:1px solid #2a5a3a}

.summary-card{background:linear-gradient(135deg,#1a2a3a,#151f30);border:1px solid #2a4560;border-radius:var(--radius);padding:14px;margin-bottom:10px;transition:border-color 0.2s}
.summary-card.filtered{border-color:rgba(74,158,255,0.3)}
.summary-cond{font-size:11px;color:var(--accent);font-weight:600;margin-bottom:4px}
.summary-total{font-size:22px;font-weight:800;font-variant-numeric:tabular-nums;margin-bottom:10px}
.summary-row{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
.summary-item{flex:1;min-width:calc(33% - 6px);padding:8px;background:rgba(255,255,255,0.04);border-radius:8px}
.summary-item .sl{font-size:10px;color:var(--text2)}
.summary-item .sv{font-size:13px;font-weight:700;font-variant-numeric:tabular-nums}
.breakdown{padding:8px 0 0;border-top:1px solid var(--border);margin-top:6px}
.bd-title{font-size:10px;color:var(--text2);font-weight:600;margin-bottom:4px}
.bd-row{display:flex;justify-content:space-between;padding:3px 0}
.bd-row .l{font-size:12px;color:#ccc}.bd-row .v{font-size:12px;font-weight:700}
.bd-bar{height:4px;background:var(--surface2);border-radius:2px;margin:2px 0 6px}
.bd-fill{height:100%;border-radius:2px}

/* Day group */
.day-header{display:flex;justify-content:space-between;align-items:center;padding:10px 4px 6px;margin-top:8px}
.day-header:first-child{margin-top:0}
.day-date{font-size:13px;font-weight:700;color:var(--text)}
.day-weekday{font-size:11px;color:var(--text2);margin-left:6px}
.day-subtotal{font-size:12px;font-weight:600;color:var(--accent);font-variant-numeric:tabular-nums}
.day-count{font-size:10px;color:var(--text2);margin-left:4px}

.entry-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-bottom:6px;cursor:pointer;transition:background 0.15s}
.entry-card:active{background:var(--surface2)}
.entry-card.checked{opacity:0.5}
.entry-top{display:flex;justify-content:space-between;align-items:flex-start}
.entry-title{font-size:13px;font-weight:600;flex:1;margin-right:8px}
.entry-amount{font-size:14px;font-weight:700;font-variant-numeric:tabular-nums;white-space:nowrap}
.entry-sub{font-size:10px;color:var(--text2)}
.entry-meta{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
.entry-tag{font-size:10px;padding:2px 7px;border-radius:5px;background:var(--surface2);color:var(--text2);font-weight:500}
.entry-tag.cat{color:var(--accent)}.entry-tag.pay{color:var(--green)}.entry-tag.cur{color:var(--orange)}
.entry-memo{font-size:11px;color:var(--text2);margin-top:5px}
.entry-balance{font-size:10px;color:var(--text2);font-variant-numeric:tabular-nums;margin-top:6px;padding-top:6px;border-top:1px solid var(--border)}
.entry-photo{margin-top:6px}
.entry-photo img{width:60px;height:45px;object-fit:cover;border-radius:6px;border:1px solid var(--border)}
.empty-state{text-align:center;padding:40px 20px;color:var(--text2)}
.empty-state .icon{font-size:48px;margin-bottom:12px}

/* Stats tab */
.chart-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.chart-title{font-size:13px;font-weight:700;margin-bottom:12px}
.chart-wrap{position:relative;width:100%}
.donut-wrap{display:flex;align-items:center;gap:16px}
.donut-canvas{flex-shrink:0}
.donut-legend{flex:1;min-width:0}
.legend-item{display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:12px}
.legend-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-right:6px}
.legend-label{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#ccc}
.legend-val{font-weight:700;font-variant-numeric:tabular-nums;margin-left:8px;white-space:nowrap}
.trend-canvas{width:100%;height:200px}

.modal-overlay{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);justify-content:center;align-items:flex-end}
.modal-overlay.open{display:flex}
.modal{width:100%;max-width:500px;max-height:90vh;overflow-y:auto;background:var(--bg);border-radius:16px 16px 0 0;padding:20px 16px 32px}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.modal-header h3{font-size:16px;font-weight:700}
.modal-close{width:32px;height:32px;border-radius:50%;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer}
.modal-actions{display:flex;gap:8px;margin-top:12px}
.btn-delete{flex:1;padding:14px;border-radius:10px;background:#3a1a1a;border:1px solid #5a2a2a;font-size:14px;font-weight:700;color:var(--red);cursor:pointer}
.btn-save{flex:2;padding:14px;border-radius:10px;background:var(--accent);font-size:14px;font-weight:700;color:#fff;cursor:pointer}

.photo-viewer{display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,0.95);justify-content:center;align-items:center;flex-direction:column}
.photo-viewer.open{display:flex}
.photo-viewer img{max-width:95%;max-height:80vh;object-fit:contain;border-radius:8px}
.photo-viewer-close{position:absolute;top:20px;right:20px;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.2);color:#fff;font-size:24px;display:flex;align-items:center;justify-content:center;cursor:pointer}

.setting-row{display:flex;justify-content:space-between;align-items:center;padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:8px;flex-wrap:wrap;gap:8px}
.setting-label{font-size:14px;font-weight:600}
.setting-desc{font-size:12px;color:var(--text2);margin-top:2px}
.setting-input{width:120px;text-align:right;padding:8px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;font-size:15px;font-weight:700}
.btn-danger{width:100%;padding:14px;margin-top:16px;background:#3a1a1a;border:1px solid #5a2a2a;border-radius:10px;font-size:14px;font-weight:700;color:var(--red);cursor:pointer}
.btn-backup{width:100%;padding:14px;margin-top:8px;background:#1a2a3a;border:1px solid #2a4a5a;border-radius:10px;font-size:14px;font-weight:700;color:var(--accent);cursor:pointer}

.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);padding:10px 20px;background:#333;color:#fff;border-radius:20px;font-size:13px;font-weight:600;z-index:300;opacity:0;transition:opacity 0.3s;pointer-events:none}
.toast.show{opacity:1}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ’° ë¶ìœ ëŸ½ íƒë°© ê³µë™ê²½ë¹„</h1>
  <button onclick="showSettings()" title="ì„¤ì •">âš™ï¸</button>
</div>

<div class="balance-card">
  <div class="bl">ì”ì•¡</div>
  <div class="balance-big pos" id="balAmt">â‚©0</div>
  <div class="balance-row" id="balRow"></div>
  <div class="cur-balance-section" id="curBalSection"></div>
</div>

<div class="today-banner" onclick="refreshAll();toast('ğŸ”„ ìƒˆë¡œê³ ì¹¨')">
  <div><div class="bl">ì˜¤ëŠ˜ ì§€ì¶œ (<span id="todayLabel"></span>)</div><div class="v" id="todayAmt">â‚©0</div></div>
  <div style="text-align:right"><div class="bl">ì˜¤ëŠ˜ ê±´ìˆ˜</div><div class="v" id="todayCount">0ê±´</div></div>
</div>

<div class="tab-nav">
  <div class="tab-btn active" data-tab="input">ì…ë ¥</div>
  <div class="tab-btn" data-tab="list">ë‚´ì—­</div>
  <div class="tab-btn" data-tab="stats">í†µê³„</div>
</div>

<!-- ===== ì…ë ¥ íƒ­ ===== -->
<div class="panel active" id="panel-input">
  <div class="fg"><label class="fl">í•­ëª© *</label><input class="fi" id="f-title" placeholder="ì˜ˆ: ì ì‹¬ ì‹ì‚¬, ë²„ìŠ¤ í‹°ì¼“" autocomplete="off"></div>
  <div class="frow">
    <div class="fg"><label class="fl">ë‚ ì§œ</label><input class="fi" type="date" id="f-date"></div>
    <div class="fg"><label class="fl">ì‹œê°„ (24ì‹œ)</label>
      <div class="time-row">
        <input class="time-field" id="f-hour" type="number" min="0" max="23" placeholder="00" inputmode="numeric">
        <span class="time-sep">:</span>
        <input class="time-field" id="f-min" type="number" min="0" max="59" placeholder="00" inputmode="numeric">
      </div>
    </div>
  </div>
  <div class="fg">
    <label class="fl">ì¹´í…Œê³ ë¦¬</label>
    <div class="chip-group" id="f-category">
      <div class="chip" data-val="ì‹ì‚¬">ğŸ½ ì‹ì‚¬</div>
      <div class="chip" data-val="êµí†µ">ğŸšŒ êµí†µ</div>
      <div class="chip" data-val="ì„ íƒê´€ê´‘">ğŸ› ì„ íƒê´€ê´‘</div>
      <div class="chip" data-val="íŒ">ğŸ’µ íŒ</div>
      <div class="chip" data-val="ìˆ™ë°•">ğŸ¨ ìˆ™ë°•</div>
      <div class="chip" data-val="ì¬ë¬´ê´€ë¦¬">ğŸ“Š ì¬ë¬´ê´€ë¦¬</div>
      <div class="chip" data-val="__custom__">ğŸ“Œ ê¸°íƒ€</div>
    </div>
    <div class="custom-input-wrap" id="customCatWrap"><input class="fi" id="f-custom-cat" placeholder="ì¹´í…Œê³ ë¦¬ ì§ì ‘ ì…ë ¥"></div>
  </div>
  <div class="fg">
    <label class="fl">í†µí™”</label>
    <div class="chip-group" id="f-currency">
      <div class="chip" data-val="EUR">ğŸ‡ªğŸ‡º EUR</div>
      <div class="chip" data-val="USD">ğŸ‡ºğŸ‡¸ USD</div>
      <div class="chip" data-val="SEK">ğŸ‡¸ğŸ‡ª SEK</div>
      <div class="chip" data-val="DKK">ğŸ‡©ğŸ‡° DKK</div>
      <div class="chip" data-val="KRW">ğŸ‡°ğŸ‡· KRW</div>
      <div class="chip" data-val="__custom__">âœï¸ ê¸°íƒ€</div>
    </div>
    <div class="custom-input-wrap" id="customCurWrap"><input class="fi" id="f-custom-cur" placeholder="í†µí™”ì½”ë“œ (ì˜ˆ: NOK, GBP)"></div>
  </div>
  <div class="frow">
    <div class="fg"><label class="fl">ê¸ˆì•¡</label><div class="amount-wrap"><input class="fi" type="number" id="f-amount" placeholder="0" step="0.01" min="0" inputmode="decimal"><span class="tag" id="f-amount-tag">---</span></div></div>
    <div class="fg"><label class="fl">í™˜ìœ¨ (â†’KRW)</label><div class="amount-wrap"><input class="fi" type="number" id="f-rate" step="0.01" min="0" inputmode="decimal"><span class="tag">â‚©</span></div></div>
  </div>
  <div class="fg">
    <label class="fl">ê²°ì œìˆ˜ë‹¨</label>
    <div class="chip-group" id="f-payment">
      <div class="chip" data-val="ì¹´ë“œ">ğŸ’³ ì¹´ë“œ</div>
      <div class="chip" data-val="í˜„ê¸ˆ">ğŸ’µ í˜„ê¸ˆ</div>
      <div class="chip" data-val="__custom__">âœï¸ ê¸°íƒ€</div>
    </div>
    <div class="custom-input-wrap" id="customPayWrap"><input class="fi" id="f-custom-pay" placeholder="ê²°ì œìˆ˜ë‹¨ ì§ì ‘ ì…ë ¥"></div>
  </div>
  <div class="fg"><label class="fl">ë©”ëª¨</label><textarea class="fi" id="f-memo" rows="2" placeholder="ë¹„ê³  ì‚¬í•­"></textarea></div>
  <div class="fg">
    <label class="fl">ğŸ“ ì¥ì†Œ</label>
    <div style="display:flex;gap:8px;align-items:center">
      <input class="fi" id="f-location" placeholder="ë„ì‹œëª… (ìë™ ë˜ëŠ” ìˆ˜ë™ ì…ë ¥)" style="flex:1">
      <button type="button" class="photo-btn" onclick="fetchLocation()" id="locBtn" style="white-space:nowrap;flex-shrink:0">ğŸ“ í˜„ì¬ ìœ„ì¹˜</button>
    </div>
  </div>
  <div class="fg">
    <label class="fl">ğŸ“· ì˜ìˆ˜ì¦</label>
    <div class="photo-area">
      <label class="photo-btn"><span>ğŸ“¸ ì‚¬ì§„ ì²¨ë¶€</span><input type="file" accept="image/*" id="f-photo" style="display:none" onchange="handlePhoto(this)"></label>
      <div class="photo-preview" id="photoPreview"><img id="photoThumb"><div class="photo-remove" onclick="removePhoto()">âœ•</div></div>
    </div>
  </div>
  <button class="btn-primary" type="button" onclick="saveEntry()">ğŸ’¾ ì €ì¥</button>
</div>

<!-- ===== ë‚´ì—­ íƒ­ ===== -->
<div class="panel" id="panel-list">
  <div class="filter-bar" id="filterBar">
    <div class="filter-row">
      <input class="fi" type="date" id="fl-from" style="flex:1">
      <span style="color:var(--text2);align-self:center;font-size:13px">~</span>
      <input class="fi" type="date" id="fl-to" style="flex:1">
    </div>
    <div class="filter-row">
      <select class="fi" id="fl-cat" style="flex:1"><option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option></select>
      <select class="fi" id="fl-cur" style="flex:1"><option value="">ì „ì²´ í†µí™”</option></select>
    </div>
    <div class="filter-row">
      <select class="fi" id="fl-pay" style="flex:1"><option value="">ì „ì²´ ê²°ì œìˆ˜ë‹¨</option></select>
      <input class="fi" id="fl-keyword" placeholder="í•­ëª©/ë©”ëª¨ ê²€ìƒ‰" style="flex:1">
    </div>
    <div class="filter-actions">
      <button class="btn-sm btn-filter" onclick="applyFilter()">ğŸ” ì¡°íšŒ</button>
      <button class="btn-sm btn-reset" onclick="resetFilter()">â†© ì´ˆê¸°í™”</button>
      <button class="btn-sm btn-export" onclick="exportCSV()">ğŸ“¥ CSV</button>
    </div>
  </div>
  <div id="summaryCard"></div>
  <div id="listContent"></div>
</div>

<!-- ===== í†µê³„ íƒ­ ===== -->
<div class="panel" id="panel-stats">
  <div class="filter-row" style="margin-bottom:10px">
    <input class="fi" type="date" id="st-from" style="flex:1">
    <span style="color:var(--text2);align-self:center;font-size:13px">~</span>
    <input class="fi" type="date" id="st-to" style="flex:1">
    <button class="btn-sm btn-reset" onclick="document.getElementById('st-from').value='';document.getElementById('st-to').value='';renderStats();" style="white-space:nowrap">â†©</button>
  </div>
  <div id="statHeader"></div>
  <div class="chart-card">
    <div class="chart-title">ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ ë¹„ìœ¨</div>
    <div class="donut-wrap">
      <canvas class="donut-canvas" id="donutChart" width="140" height="140"></canvas>
      <div class="donut-legend" id="donutLegend"></div>
    </div>
  </div>
  <div class="chart-card">
    <div class="chart-title">ğŸ’³ ê²°ì œìˆ˜ë‹¨ë³„ ë¹„ìœ¨</div>
    <div class="donut-wrap">
      <canvas class="donut-canvas" id="payDonutChart" width="140" height="140"></canvas>
      <div class="donut-legend" id="payDonutLegend"></div>
    </div>
  </div>
  <div class="chart-card">
    <div class="chart-title">ğŸ’± í†µí™”ë³„ ì§€ì¶œ</div>
    <div id="curBreakdown"></div>
  </div>
  <div class="chart-card">
    <div class="chart-title">ğŸ“ˆ ì¼ë³„ ì§€ì¶œ ì¶”ì´</div>
    <canvas class="trend-canvas" id="trendChart"></canvas>
  </div>
  <div class="chart-card">
    <div class="chart-title">ğŸ“ ì¥ì†Œë³„ ì§€ì¶œ</div>
    <div class="donut-wrap">
      <canvas class="donut-canvas" id="locDonutChart" width="140" height="140"></canvas>
      <div class="donut-legend" id="locDonutLegend"></div>
    </div>
    <div id="locBreakdown" style="margin-top:8px"></div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal"><div class="modal"><div class="modal-header"><h3>ë‚´ì—­ ìˆ˜ì •</h3><div class="modal-close" onclick="closeModal()">âœ•</div></div><div id="modalBody"></div></div></div>
<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal"><div class="modal">
  <div class="modal-header"><h3>âš™ï¸ ì„¤ì •</h3><div class="modal-close" onclick="closeSettings()">âœ•</div></div>
  <div class="setting-row"><div><div class="setting-label">ì›ê¸ˆ (KRW)</div><div class="setting-desc">ê³µë™ê²½ë¹„ ì´ì•¡</div></div><input class="setting-input" type="number" id="s-fund" inputmode="numeric"></div>
  <div style="padding:8px 0 4px;font-size:13px;font-weight:700;color:var(--orange)">ê¸°ë³¸ í™˜ìœ¨ (1 ë‹¨ìœ„ â†’ KRW)</div>
  <div class="setting-row"><div><div class="setting-label">ğŸ‡ªğŸ‡º EUR</div></div><input class="setting-input" type="number" id="s-rate-EUR" step="0.01" inputmode="decimal"></div>
  <div class="setting-row"><div><div class="setting-label">ğŸ‡ºğŸ‡¸ USD</div></div><input class="setting-input" type="number" id="s-rate-USD" step="0.01" inputmode="decimal"></div>
  <div class="setting-row"><div><div class="setting-label">ğŸ‡¸ğŸ‡ª SEK</div></div><input class="setting-input" type="number" id="s-rate-SEK" step="0.01" inputmode="decimal"></div>
  <div class="setting-row"><div><div class="setting-label">ğŸ‡©ğŸ‡° DKK</div></div><input class="setting-input" type="number" id="s-rate-DKK" step="0.01" inputmode="decimal"></div>
  <button class="btn-primary" onclick="saveSettings()">ì €ì¥</button>
  <button class="btn-backup" onclick="exportJSON()">ğŸ“¦ ì „ì²´ ë°±ì—… (JSON)</button>
  <label class="btn-backup" style="text-align:center;display:block;cursor:pointer">ğŸ“‚ ë°±ì—… ë³µì›<input type="file" accept=".json" onchange="importJSON(event)" style="display:none"></label>
  <button class="btn-danger" onclick="confirmReset()">âš ï¸ ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”</button>
</div></div>
<!-- Photo Viewer -->
<div class="photo-viewer" id="photoViewer" onclick="this.classList.remove('open')"><div class="photo-viewer-close">âœ•</div><img id="photoViewerImg"></div>
<div class="toast" id="toast"></div>

<script>
const SK='nordic_expense_v2',SSK='nordic_settings_v2',DB_NAME='nordic_receipts',DB_STORE='photos';
const defaultRates={EUR:1500,USD:1450,SEK:140,DKK:210,KRW:1};
const curSymbols={EUR:'â‚¬',USD:'$',SEK:'kr',DKK:'kr',KRW:'â‚©'};
const curFlags={EUR:'ğŸ‡ªğŸ‡º',USD:'ğŸ‡ºğŸ‡¸',SEK:'ğŸ‡¸ğŸ‡ª',DKK:'ğŸ‡©ğŸ‡°',KRW:'ğŸ‡°ğŸ‡·'};
const curColorMap={EUR:'var(--orange)',USD:'#38bdf8',SEK:'var(--green)',DKK:'var(--yellow)',KRW:'var(--purple)'};
const catIcons={'ì‹ì‚¬':'ğŸ½','êµí†µ':'ğŸšŒ','ì„ íƒê´€ê´‘':'ğŸ›','íŒ':'ğŸ’µ','ìˆ™ë°•':'ğŸ¨','ì¬ë¬´ê´€ë¦¬':'ğŸ“Š'};
const chartColors=['#4a9eff','#34d399','#fbbf24','#a78bfa','#f87171','#fb923c','#38bdf8','#e879f9','#f472b6','#6ee7b7'];

const getSettings=()=>{try{const s=JSON.parse(localStorage.getItem(SSK));return{fund:s?.fund||5400000,rates:{...defaultRates,...(s?.rates||{})}};}catch(e){return{fund:5400000,rates:{...defaultRates}};}};
const setSettings=s=>localStorage.setItem(SSK,JSON.stringify(s));
const getEntries=()=>{try{return JSON.parse(localStorage.getItem(SK))||[];}catch(e){return[];}};
const setEntries=a=>localStorage.setItem(SK,JSON.stringify(a));
const genId=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,6);
const todayStr=()=>{const d=new Date();return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');};
const nowTime=()=>{const d=new Date();return{h:d.getHours(),m:d.getMinutes()};};
const fK=n=>'â‚©'+Math.round(n).toLocaleString('ko-KR');
const fCur=(n,cur)=>{const s=curSymbols[cur]||cur+' ';return cur==='KRW'?fK(n):s+Number(n).toLocaleString('ko-KR',{minimumFractionDigits:0,maximumFractionDigits:2});};
const fD=d=>{if(!d)return'';const t=new Date(d+'T00:00:00');return(t.getMonth()+1)+'/'+t.getDate();};
const fDFull=d=>{if(!d)return'';const t=new Date(d+'T00:00:00');return(t.getMonth()+1)+'ì›” '+t.getDate()+'ì¼';};
const weekdayName=d=>{if(!d)return'';return['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][new Date(d+'T00:00:00').getDay()];};
const esc=s=>(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const getCurColor=c=>curColorMap[c]||'var(--green)';
const toKRW=(e,s)=>(e.amount||0)*(e.currency==='KRW'?1:(e.rate||s?.rates?.[e.currency]||1));

// ===== IndexedDB =====
let db=null;
function openDB(){return new Promise((resolve,reject)=>{
  const req=indexedDB.open(DB_NAME,1);
  req.onupgradeneeded=e=>{e.target.result.createObjectStore(DB_STORE,{keyPath:'id'});};
  req.onsuccess=e=>{db=e.target.result;resolve(db);};
  req.onerror=e=>reject(e);
});}
async function savePhotoDB(id,dataUrl){if(!db)await openDB();return new Promise((r,j)=>{const tx=db.transaction(DB_STORE,'readwrite');tx.objectStore(DB_STORE).put({id,data:dataUrl,ts:Date.now()});tx.oncomplete=()=>r();tx.onerror=e=>j(e);});}
async function getPhotoDB(id){if(!db)await openDB();return new Promise((r,j)=>{const tx=db.transaction(DB_STORE,'readonly');const req=tx.objectStore(DB_STORE).get(id);req.onsuccess=()=>r(req.result?.data||null);req.onerror=e=>j(e);});}
async function deletePhotoDB(id){if(!db)await openDB();return new Promise((r,j)=>{const tx=db.transaction(DB_STORE,'readwrite');tx.objectStore(DB_STORE).delete(id);tx.oncomplete=()=>r();tx.onerror=e=>j(e);});}
async function getAllPhotos(){if(!db)await openDB();return new Promise((r,j)=>{const req=db.transaction(DB_STORE,'readonly').objectStore(DB_STORE).getAll();req.onsuccess=()=>r(req.result||[]);req.onerror=e=>j(e);});}

// ===== v1 â†’ v2 Migration =====
(function(){
  const old=localStorage.getItem('nordic_expense_v1');
  if(!old||localStorage.getItem(SK))return;
  try{
    const entries=JSON.parse(old).map(e=>{
      let currency='EUR',amount=e.eur||0,payment='í˜„ê¸ˆ';
      if((e.krw||0)>0&&(e.eur||0)===0){currency='KRW';amount=e.krw;}
      if((e.payment||'').includes('ì¹´ë“œ')||e.payment==='ë„¤ì´ë²„ì¹´ë“œ')payment='ì¹´ë“œ';
      const rate=currency==='KRW'?1:(e.rate||1500);
      const m={...e,currency,amount,rate,payment};
      delete m.eur;delete m.krw;return m;
    });
    setEntries(entries);
    const os=localStorage.getItem('nordic_settings_v1');
    if(os){const o=JSON.parse(os);setSettings({fund:o.fund||5400000,rates:{...defaultRates,EUR:o.defaultRate||1500}});}
  }catch(e){console.error('migration',e);}
})();

// ===== Tabs =====
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('panel-'+btn.dataset.tab).classList.add('active');
    refreshAll();
    if(btn.dataset.tab==='list'){updateFilters();renderList();}
    if(btn.dataset.tab==='stats'){renderStats();}
  });
});

// ===== Chip Toggle =====
function setupChipGroup(groupId,wrapId,inputId){
  document.querySelectorAll('#'+groupId+' .chip').forEach(chip=>{
    chip.addEventListener('click',()=>{
      const wasActive=chip.classList.contains('active');
      document.querySelectorAll('#'+groupId+' .chip').forEach(c=>c.classList.remove('active'));
      const wrap=wrapId?document.getElementById(wrapId):null;
      const inp=inputId?document.getElementById(inputId):null;
      if(wasActive){if(wrap)wrap.classList.remove('show');if(inp)inp.value='';}
      else{chip.classList.add('active');
        if(chip.dataset.val==='__custom__'){if(wrap)wrap.classList.add('show');if(inp)inp.focus();}
        else{if(wrap)wrap.classList.remove('show');if(inp)inp.value='';}
      }
      if(groupId==='f-currency')updateCurrencyUI();
    });
  });
}
setupChipGroup('f-category','customCatWrap','f-custom-cat');
setupChipGroup('f-currency','customCurWrap','f-custom-cur');
setupChipGroup('f-payment','customPayWrap','f-custom-pay');

function getChipVal(groupId,inputId){
  const chip=document.querySelector('#'+groupId+' .chip.active');
  if(!chip)return'';
  if(chip.dataset.val==='__custom__')return inputId?document.getElementById(inputId).value.trim():'';
  return chip.dataset.val;
}
function updateCurrencyUI(){
  const cur=getChipVal('f-currency','f-custom-cur');
  document.getElementById('f-amount-tag').textContent=cur||'---';
  const s=getSettings();
  if(cur==='KRW')document.getElementById('f-rate').value=1;
  else if(cur&&s.rates[cur])document.getElementById('f-rate').value=s.rates[cur];
  else document.getElementById('f-rate').value='';
}
document.getElementById('f-custom-cur').addEventListener('input',updateCurrencyUI);

document.getElementById('f-hour').addEventListener('input',function(){if(parseInt(this.value)>23)this.value=23;if(this.value.length>=2)document.getElementById('f-min').focus();});
document.getElementById('f-min').addEventListener('input',function(){if(parseInt(this.value)>59)this.value=59;});

function setFormDefaults(){
  document.getElementById('f-date').value=todayStr();
  const t=nowTime();
  document.getElementById('f-hour').value=String(t.h).padStart(2,'0');
  document.getElementById('f-min').value=String(t.m).padStart(2,'0');
  document.getElementById('f-rate').value='';
  document.getElementById('f-amount-tag').textContent='---';
}
setFormDefaults();

function getFormTime(){return String(parseInt(document.getElementById('f-hour').value)||0).padStart(2,'0')+':'+String(parseInt(document.getElementById('f-min').value)||0).padStart(2,'0');}

// ===== Photo =====
let pendingPhotoData=null;
function handlePhoto(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    const img=new Image();img.onload=function(){
      const c=document.createElement('canvas');const maxW=800;let w=img.width,h=img.height;
      if(w>maxW){h=Math.round(h*(maxW/w));w=maxW;}
      c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);
      pendingPhotoData=c.toDataURL('image/jpeg',0.7);
      document.getElementById('photoThumb').src=pendingPhotoData;
      document.getElementById('photoPreview').classList.add('show');
    };img.src=e.target.result;
  };reader.readAsDataURL(file);
}
function removePhoto(){pendingPhotoData=null;document.getElementById('photoPreview').classList.remove('show');document.getElementById('f-photo').value='';}

// ===== Location (Nominatim) =====
async function fetchLocation(){
  const btn=document.getElementById('locBtn');
  const inp=document.getElementById('f-location');
  if(!navigator.geolocation){toast('ì´ ë¸Œë¼ìš°ì €ì—ì„œ GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');return;}
  btn.textContent='â³ ì¡°íšŒì¤‘...';btn.disabled=true;
  navigator.geolocation.getCurrentPosition(async pos=>{
    try{
      const lat=pos.coords.latitude,lon=pos.coords.longitude;
      const res=await fetch('https://nominatim.openstreetmap.org/reverse?lat='+lat+'&lon='+lon+'&format=json&accept-language=ko&zoom=14',{headers:{'User-Agent':'NordicExpenseApp/1.0'}});
      const data=await res.json();
      const addr=data.address||{};
      const detail=addr.suburb||addr.neighbourhood||addr.borough||addr.quarter||addr.district||addr.town_district||addr.village||addr.hamlet||addr.town||'';
      const city=addr.city||addr.town||addr.county||addr.state||'';
      const country=addr.country||'';
      let loc='';
      if(detail&&city&&detail!==city)loc=detail+', '+city;
      else if(city)loc=city;
      else if(detail)loc=detail;
      else loc=country;
      inp.value=loc;
      toast('ğŸ“ '+loc);
    }catch(e){toast('ìœ„ì¹˜ ë³€í™˜ ì‹¤íŒ¨: ìˆ˜ë™ ì…ë ¥í•´ì£¼ì„¸ìš”');console.error(e);}
    btn.textContent='ğŸ“ í˜„ì¬ ìœ„ì¹˜';btn.disabled=false;
  },err=>{
    btn.textContent='ğŸ“ í˜„ì¬ ìœ„ì¹˜';btn.disabled=false;
    if(err.code===1)toast('ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤');
    else if(err.code===2)toast('ìœ„ì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    else toast('ìœ„ì¹˜ ì¡°íšŒ ì‹œê°„ ì´ˆê³¼');
  },{enableHighAccuracy:false,timeout:10000,maximumAge:300000});
}

// ===== Save =====
async function saveEntry(){
  const title=document.getElementById('f-title').value.trim();
  if(!title){toast('í•­ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  const amount=parseFloat(document.getElementById('f-amount').value)||0;
  if(amount===0){toast('ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  const currency=getChipVal('f-currency','f-custom-cur');
  if(!currency){toast('í†µí™”ë¥¼ ì„ íƒí•˜ì„¸ìš”');return;}
  const s=getSettings();
  const rate=currency==='KRW'?1:(parseFloat(document.getElementById('f-rate').value)||s.rates[currency]||1);
  if(currency!=='KRW'&&!parseFloat(document.getElementById('f-rate').value)&&!s.rates[currency]){toast('í™˜ìœ¨ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  const category=getChipVal('f-category','f-custom-cat');
  const payment=getChipVal('f-payment','f-custom-pay');
  let photoId=null;
  if(pendingPhotoData){photoId=genId()+'_p';try{await savePhotoDB(photoId,pendingPhotoData);}catch(e){console.error(e);}}
  const entry={id:genId(),title,date:document.getElementById('f-date').value,time:getFormTime(),category,currency,amount,rate,payment,memo:document.getElementById('f-memo').value.trim(),location:document.getElementById('f-location').value.trim(),photoId,checked:false,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};
  const entries=getEntries();entries.push(entry);setEntries(entries);
  if(currency!=='KRW'){s.rates[currency]=rate;setSettings(s);}
  document.getElementById('f-title').value='';document.getElementById('f-amount').value='';document.getElementById('f-memo').value='';document.getElementById('f-location').value='';
  document.querySelectorAll('#f-category .chip,#f-payment .chip').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.custom-input-wrap').forEach(w=>w.classList.remove('show'));
  ['f-custom-cat','f-custom-cur','f-custom-pay'].forEach(id=>document.getElementById(id).value='');
  removePhoto();setFormDefaults();refreshAll();toast('âœ… ì €ì¥ë¨');document.getElementById('f-title').focus();
}

// ===== Dashboard =====
function refreshAll(){
  const entries=getEntries(),s=getSettings(),today=todayStr();
  const byCur={};let tConv=0,tdConv=0,tdCnt=0;
  entries.forEach(e=>{
    const cur=e.currency||'KRW';byCur[cur]=(byCur[cur]||0)+(e.amount||0);
    const cv=toKRW(e,s);tConv+=cv;
    if(e.date===today){tdConv+=cv;tdCnt++;}
  });
  const bal=s.fund-tConv;
  document.getElementById('balAmt').textContent=fK(bal);
  document.getElementById('balAmt').className='balance-big '+(bal>=0?'pos':'neg');
  // ê¸°ì¡´ í†µí™”ë³„ ì§€ì¶œ
  let rHtml='';
  const curOrder=['EUR','USD','SEK','DKK','KRW'].concat(Object.keys(byCur).filter(c=>!['EUR','USD','SEK','DKK','KRW'].includes(c)));
  curOrder.forEach(cur=>{
    if(!byCur[cur])return;
    rHtml+='<div class="balance-item"><div class="bl">'+(curFlags[cur]||'ğŸ’±')+' '+cur+'</div><div class="v" style="color:'+getCurColor(cur)+'">'+fCur(byCur[cur],cur)+'</div></div>';
  });
  rHtml+='<div class="balance-item"><div class="bl">ì´ ì›í™”í™˜ì‚°</div><div class="v">'+fK(tConv)+'</div></div>';
  document.getElementById('balRow').innerHTML=rHtml;

  // í†µí™”ë³„ ì”ì•¡ ìš”ì•½
  let cbHtml='';
  const activeCurs=curOrder.filter(c=>byCur[c]&&c!=='KRW');
  if(activeCurs.length>0){
    cbHtml+='<div style="font-size:10px;color:var(--text2);font-weight:600;margin-bottom:4px">í†µí™”ë³„ ì›í™”í™˜ì‚° ë‚´ì—­</div>';
    activeCurs.forEach(cur=>{
      const krwVal=byCur[cur]*(s.rates[cur]||1);
      const pct=tConv>0?(krwVal/tConv*100).toFixed(0):'0';
      cbHtml+='<div class="cur-bal-row"><span class="cur-bal-label">'+(curFlags[cur]||'ğŸ’±')+' '+cur+' '+fCur(byCur[cur],cur)+'</span><span class="cur-bal-spent" style="color:'+getCurColor(cur)+'">'+fK(krwVal)+' <span style="font-size:10px;color:var(--text2)">('+pct+'%)</span></span></div>';
    });
    if(byCur['KRW']){
      const pct=tConv>0?(byCur['KRW']/tConv*100).toFixed(0):'0';
      cbHtml+='<div class="cur-bal-row"><span class="cur-bal-label">ğŸ‡°ğŸ‡· KRW ì§ì ‘ê²°ì œ</span><span class="cur-bal-spent" style="color:var(--purple)">'+fK(byCur['KRW'])+' <span style="font-size:10px;color:var(--text2)">('+pct+'%)</span></span></div>';
    }
  }
  document.getElementById('curBalSection').innerHTML=cbHtml;
  document.getElementById('curBalSection').style.display=cbHtml?'':'none';

  document.getElementById('todayAmt').textContent=fK(tdConv);
  document.getElementById('todayCount').textContent=tdCnt+'ê±´';
  document.getElementById('todayLabel').textContent=today;
}
refreshAll();

// ===== Filters =====
function updateFilters(){
  const entries=getEntries(),cats=new Set(),curs=new Set(),pays=new Set();
  entries.forEach(e=>{if(e.category)cats.add(e.category);if(e.currency)curs.add(e.currency);if(e.payment)pays.add(e.payment);});
  const fill=(id,vals)=>{const sel=document.getElementById(id),first=sel.options[0].text,cur=sel.value;
    sel.innerHTML='<option value="">'+first+'</option>';[...vals].sort().forEach(v=>{sel.innerHTML+='<option '+(v===cur?'selected':'')+'>'+esc(v)+'</option>';});};
  fill('fl-cat',cats);fill('fl-cur',curs);fill('fl-pay',pays);
}
function hasActiveFilter(){return document.getElementById('fl-from').value||document.getElementById('fl-to').value||document.getElementById('fl-cat').value||document.getElementById('fl-cur').value||document.getElementById('fl-pay').value||document.getElementById('fl-keyword').value.trim();}
function getFilteredEntries(){
  let e=getEntries();
  const from=document.getElementById('fl-from').value,to=document.getElementById('fl-to').value;
  const cat=document.getElementById('fl-cat').value,cur=document.getElementById('fl-cur').value,pay=document.getElementById('fl-pay').value;
  const kw=document.getElementById('fl-keyword').value.trim().toLowerCase();
  if(from)e=e.filter(x=>x.date>=from);if(to)e=e.filter(x=>x.date<=to);
  if(cat)e=e.filter(x=>x.category===cat);if(cur)e=e.filter(x=>x.currency===cur);if(pay)e=e.filter(x=>x.payment===pay);
  if(kw)e=e.filter(x=>(x.title||'').toLowerCase().includes(kw)||(x.memo||'').toLowerCase().includes(kw));
  e.sort((a,b)=>{const d=(b.date||'').localeCompare(a.date||'');return d!==0?d:(b.time||'').localeCompare(a.time||'');});
  return e;
}
function applyFilter(){renderList();}
function resetFilter(){['fl-from','fl-to','fl-keyword'].forEach(id=>document.getElementById(id).value='');['fl-cat','fl-cur','fl-pay'].forEach(id=>document.getElementById(id).value='');renderList();}

function renderList(){
  const entries=getFilteredEntries(),s=getSettings(),isFiltered=hasActiveFilter();
  document.getElementById('filterBar').classList.toggle('has-filter',!!isFiltered);
  const byCur={},byCat={},byPay={};let sConv=0;
  entries.forEach(e=>{const cv=toKRW(e,s);sConv+=cv;const cur=e.currency||'?';byCur[cur]=(byCur[cur]||0)+(e.amount||0);byCat[e.category||'ë¯¸ë¶„ë¥˜']=(byCat[e.category||'ë¯¸ë¶„ë¥˜']||0)+cv;byPay[e.payment||'ë¯¸ë¶„ë¥˜']=(byPay[e.payment||'ë¯¸ë¶„ë¥˜']||0)+cv;});
  let conds=[];
  const from=document.getElementById('fl-from').value,to=document.getElementById('fl-to').value;
  if(from||to)conds.push((from?fD(from):'')+'~'+(to?fD(to):''));
  ['fl-cat','fl-cur','fl-pay'].forEach(id=>{const v=document.getElementById(id).value;if(v)conds.push(v);});
  const kw=document.getElementById('fl-keyword').value.trim();if(kw)conds.push('"'+kw+'"');
  let h='<div class="summary-card'+(isFiltered?' filtered':'')+'"><div class="summary-cond">'+(isFiltered?'ğŸ” '+esc(conds.join(' Â· '))+' Â· '+entries.length+'ê±´':'ğŸ“Š ì „ì²´ Â· '+entries.length+'ê±´')+'</div><div class="summary-total">'+fK(sConv)+'</div><div class="summary-row">';
  Object.entries(byCur).sort((a,b)=>b[1]-a[1]).forEach(([cur,amt])=>{h+='<div class="summary-item"><div class="sl">'+(curFlags[cur]||'ğŸ’±')+' '+cur+'</div><div class="sv" style="color:'+getCurColor(cur)+'">'+fCur(amt,cur)+'</div></div>';});
  h+='<div class="summary-item"><div class="sl">ì›í™”í™˜ì‚°</div><div class="sv">'+fK(sConv)+'</div></div></div>';
  const renderBD=(title,data,offset)=>{const arr=Object.entries(data).sort((a,b)=>b[1]-a[1]);if(arr.length<2)return'';let r='<div class="breakdown"><div class="bd-title">'+title+'</div>';
    arr.forEach(([k,v],i)=>{const p=sConv>0?(v/sConv*100).toFixed(0):'0';r+='<div class="bd-row"><span class="l">'+esc(k)+'</span><span class="v">'+fK(v)+' ('+p+'%)</span></div><div class="bd-bar"><div class="bd-fill" style="width:'+p+'%;background:'+chartColors[(i+offset)%chartColors.length]+'"></div></div>';});return r+'</div>';};
  h+=renderBD('ì¹´í…Œê³ ë¦¬ë³„',byCat,0)+renderBD('ê²°ì œìˆ˜ë‹¨ë³„',byPay,3)+'</div>';
  document.getElementById('summaryCard').innerHTML=h;

  const container=document.getElementById('listContent');
  if(!entries.length){container.innerHTML='<div class="empty-state"><div class="icon">ğŸ“­</div><p>ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';return;}
  // ì”ì•¡ë§µ
  const all=getEntries().sort((a,b)=>{const d=(a.date||'').localeCompare(b.date||'');return d!==0?d:(a.time||'').localeCompare(b.time||'');});
  const balMap={};let run=s.fund;all.forEach(e=>{run-=toKRW(e,s);balMap[e.id]=run;});

  // ì¼ë³„ ê·¸ë£¹í•‘
  const groups=[];let curDate=null,curGroup=null;
  entries.forEach(e=>{
    if(e.date!==curDate){curDate=e.date;curGroup={date:e.date,items:[],total:0};groups.push(curGroup);}
    curGroup.items.push(e);curGroup.total+=toKRW(e,s);
  });

  let listH='';
  groups.forEach(g=>{
    const wd=weekdayName(g.date);
    listH+='<div class="day-header"><div><span class="day-date">'+fDFull(g.date)+'</span><span class="day-weekday">('+wd+')</span></div><div><span class="day-subtotal">'+fK(g.total)+'</span><span class="day-count"> Â· '+g.items.length+'ê±´</span></div></div>';
    g.items.forEach(e=>{
      const cv=toKRW(e,s);
      let amtH='<span class="entry-amount" style="color:'+getCurColor(e.currency)+'">'+fCur(e.amount,e.currency)+'</span>';
      if(e.currency!=='KRW')amtH+='<br><span class="entry-sub">= '+fK(cv)+'</span>';
      listH+='<div class="entry-card'+(e.checked?' checked':'')+'" onclick="openEdit(\''+e.id+'\')"><div class="entry-top"><div class="entry-title">'+(e.checked?'âœ… ':'')+esc(e.title)+'</div><div style="text-align:right">'+amtH+'</div></div><div class="entry-meta"><span class="entry-tag">'+(e.time||'')+'</span>'+(e.category?'<span class="entry-tag cat">'+esc(e.category)+'</span>':'')+(e.currency?'<span class="entry-tag cur">'+e.currency+'</span>':'')+(e.payment?'<span class="entry-tag pay">'+esc(e.payment)+'</span>':'')+(e.location?'<span class="entry-tag" style="color:var(--purple)">ğŸ“'+esc(e.location)+'</span>':'')+'</div>'+(e.memo?'<div class="entry-memo">ğŸ“ '+esc(e.memo)+'</div>':'')+(e.photoId?'<div class="entry-photo" onclick="event.stopPropagation();viewPhoto(\''+e.photoId+'\')"><img id="thumb_'+e.id+'" data-pid="'+e.photoId+'"></div>':'')+'<div class="entry-balance">ì”ì•¡ '+fK(balMap[e.id]||0)+'</div></div>';
    });
  });
  container.innerHTML=listH;
  entries.forEach(e=>{if(!e.photoId)return;const el=document.getElementById('thumb_'+e.id);if(el)getPhotoDB(e.photoId).then(d=>{if(d)el.src=d;else el.parentElement.style.display='none';}).catch(()=>{});});
}

async function viewPhoto(pid){const d=await getPhotoDB(pid);if(!d){toast('ì‚¬ì§„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');return;}document.getElementById('photoViewerImg').src=d;document.getElementById('photoViewer').classList.add('open');}

// ===== Stats Tab =====
document.getElementById('st-from').addEventListener('change',renderStats);
document.getElementById('st-to').addEventListener('change',renderStats);

function getStatEntries(){
  const entries=getEntries();
  const from=document.getElementById('st-from').value,to=document.getElementById('st-to').value;
  return entries.filter(e=>{if(from&&e.date<from)return false;if(to&&e.date>to)return false;return true;});
}

function renderStats(){
  const entries=getStatEntries(),s=getSettings();
  let total=0;const byCat={},byPay={},byCur={},byDay={},byLoc={};
  entries.forEach(e=>{
    const cv=toKRW(e,s);total+=cv;
    byCat[e.category||'ë¯¸ë¶„ë¥˜']=(byCat[e.category||'ë¯¸ë¶„ë¥˜']||0)+cv;
    byPay[e.payment||'ë¯¸ë¶„ë¥˜']=(byPay[e.payment||'ë¯¸ë¶„ë¥˜']||0)+cv;
    const cur=e.currency||'KRW';byCur[cur]=(byCur[cur]||0)+(e.amount||0);
    byDay[e.date||'?']=(byDay[e.date||'?']||0)+cv;
    const loc=e.location||'ë¯¸ì§€ì •';byLoc[loc]=(byLoc[loc]||0)+cv;
  });

  // Header
  const from=document.getElementById('st-from').value,to=document.getElementById('st-to').value;
  const isFiltered=from||to;
  const label=isFiltered?((from?fD(from):'')+'~'+(to?fD(to):'')):'ì „ì²´ ê¸°ê°„';
  document.getElementById('statHeader').innerHTML=
    '<div class="summary-card'+(isFiltered?' filtered':'')+'">'+
    '<div class="summary-cond">'+(isFiltered?'ğŸ” ':'')+label+' Â· '+entries.length+'ê±´</div>'+
    '<div class="summary-total">'+fK(total)+'</div></div>';

  drawDonut('donutChart','donutLegend',byCat,total,true);
  drawDonut('payDonutChart','payDonutLegend',byPay,total,false);
  renderCurBreakdown(byCur,s,total);
  drawTrend(byDay);
  drawDonut('locDonutChart','locDonutLegend',byLoc,total,false);
  renderLocBreakdown(byLoc,total);
}

function drawDonut(canvasId,legendId,data,total,useCatIcons){
  const canvas=document.getElementById(canvasId);
  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  canvas.width=140*dpr;canvas.height=140*dpr;
  canvas.style.width='140px';canvas.style.height='140px';
  ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,140,140);

  const cx=70,cy=70,outerR=60,innerR=36;
  const sorted=Object.entries(data).sort((a,b)=>b[1]-a[1]);

  if(!sorted.length){
    ctx.fillStyle='#2e3345';ctx.beginPath();ctx.arc(cx,cy,outerR,0,Math.PI*2);ctx.arc(cx,cy,innerR,0,Math.PI*2,true);ctx.fill();
    document.getElementById(legendId).innerHTML='<div style="font-size:12px;color:var(--text2);text-align:center;padding:20px">ë°ì´í„° ì—†ìŒ</div>';
    return;
  }

  let startAngle=-Math.PI/2;
  sorted.forEach(([k,val],i)=>{
    const sliceAngle=(val/total)*Math.PI*2;
    ctx.fillStyle=chartColors[i%chartColors.length];
    ctx.beginPath();
    ctx.moveTo(cx+Math.cos(startAngle)*innerR,cy+Math.sin(startAngle)*innerR);
    ctx.arc(cx,cy,outerR,startAngle,startAngle+sliceAngle);
    ctx.arc(cx,cy,innerR,startAngle+sliceAngle,startAngle,true);
    ctx.closePath();ctx.fill();
    startAngle+=sliceAngle;
  });
  ctx.fillStyle='#0f1117';ctx.beginPath();ctx.arc(cx,cy,innerR-1,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#9498a8';ctx.font='10px -apple-system,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(sorted.length+'ê°œ',cx,cy-6);
  ctx.fillStyle='#e8eaf0';ctx.font='bold 12px -apple-system,sans-serif';
  ctx.fillText(fK(total),cx,cy+8);

  let legH='';
  sorted.forEach(([k,val],i)=>{
    const pct=total>0?(val/total*100).toFixed(1):'0';
    const icon=useCatIcons?(catIcons[k]||'ğŸ“Œ'):'';
    legH+='<div class="legend-item"><span class="legend-dot" style="background:'+chartColors[i%chartColors.length]+'"></span><span class="legend-label">'+icon+(icon?' ':'')+esc(k)+'</span><span class="legend-val">'+pct+'%</span></div>';
  });
  document.getElementById(legendId).innerHTML=legH;
}

function renderCurBreakdown(byCur,s,total){
  const sorted=Object.entries(byCur).sort((a,b)=>{
    const aK=a[1]*(s.rates[a[0]]||1),bK=b[1]*(s.rates[b[0]]||1);return bK-aK;
  });
  if(!sorted.length){document.getElementById('curBreakdown').innerHTML='<div style="font-size:12px;color:var(--text2);text-align:center;padding:20px">ë°ì´í„° ì—†ìŒ</div>';return;}
  let h='';
  sorted.forEach(([cur,amt],i)=>{
    const krwVal=amt*(cur==='KRW'?1:(s.rates[cur]||1));
    const pct=total>0?(krwVal/total*100).toFixed(0):'0';
    h+='<div class="bd-row"><span class="l">'+(curFlags[cur]||'ğŸ’±')+' '+cur+' '+fCur(amt,cur)+'</span><span class="v" style="color:'+getCurColor(cur)+'">'+fK(krwVal)+' ('+pct+'%)</span></div><div class="bd-bar"><div class="bd-fill" style="width:'+pct+'%;background:'+getCurColor(cur)+'"></div></div>';
  });
  document.getElementById('curBreakdown').innerHTML=h;
}

function renderLocBreakdown(byLoc,total){
  const sorted=Object.entries(byLoc).sort((a,b)=>b[1]-a[1]);
  if(!sorted.length||sorted.length<2){document.getElementById('locBreakdown').innerHTML='';return;}
  let h='<div style="padding-top:8px;border-top:1px solid var(--border);margin-top:4px">';
  sorted.forEach(([loc,val],i)=>{
    const pct=total>0?(val/total*100).toFixed(0):'0';
    h+='<div class="bd-row"><span class="l">ğŸ“ '+esc(loc)+'</span><span class="v">'+fK(val)+' ('+pct+'%)</span></div><div class="bd-bar"><div class="bd-fill" style="width:'+pct+'%;background:'+chartColors[i%chartColors.length]+'"></div></div>';
  });
  document.getElementById('locBreakdown').innerHTML=h+'</div>';
}

function drawTrend(byDay){
  const canvas=document.getElementById('trendChart');
  const rect=canvas.parentElement.getBoundingClientRect();
  const W=rect.width-32,H=200;
  const dpr=window.devicePixelRatio||1;
  canvas.width=W*dpr;canvas.height=H*dpr;
  canvas.style.width=W+'px';canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,W,H);

  const days=Object.keys(byDay).sort();
  if(days.length<1){
    ctx.fillStyle='#9498a8';ctx.font='13px -apple-system,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('ë°ì´í„° ì—†ìŒ',W/2,H/2);return;
  }

  // Fill in missing dates
  const allDates=[];
  if(days.length>1){
    const start=new Date(days[0]+'T00:00:00'),end=new Date(days[days.length-1]+'T00:00:00');
    for(let d=new Date(start);d<=end;d.setDate(d.getDate()+1)){
      allDates.push(d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'));
    }
  } else { allDates.push(days[0]); }

  const values=allDates.map(d=>byDay[d]||0);
  const maxVal=Math.max(...values,1);

  const padL=48,padR=12,padT=20,padB=36;
  const chartW=W-padL-padR,chartH=H-padT-padB;
  const barW=Math.min(Math.max(chartW/allDates.length-2,4),30);
  const gap=(chartW-barW*allDates.length)/Math.max(allDates.length-1,1);
  const step=barW+Math.max(gap,2);

  // Y axis
  ctx.fillStyle='#555a6e';ctx.font='10px -apple-system,sans-serif';ctx.textAlign='right';ctx.textBaseline='middle';
  for(let i=0;i<=4;i++){
    const y=padT+chartH*(1-i/4);
    const val=maxVal*i/4;
    ctx.fillText(val>=10000?(Math.round(val/1000)+'k'):Math.round(val),padL-6,y);
    ctx.strokeStyle='#1e2230';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(padL,y);ctx.lineTo(W-padR,y);ctx.stroke();
  }

  // Bars
  allDates.forEach((date,i)=>{
    const val=byDay[date]||0;
    const barH=maxVal>0?(val/maxVal)*chartH:0;
    const x=padL+i*step;
    const y=padT+chartH-barH;

    // Bar gradient
    const grad=ctx.createLinearGradient(0,y,0,padT+chartH);
    grad.addColorStop(0,'#4a9eff');grad.addColorStop(1,'#2a5faf');
    ctx.fillStyle=val>0?grad:'transparent';

    const radius=Math.min(barW/2,4);
    if(barH>radius){
      ctx.beginPath();ctx.moveTo(x,y+radius);ctx.arcTo(x,y,x+barW,y,radius);ctx.arcTo(x+barW,y,x+barW,y+barH,radius);ctx.lineTo(x+barW,padT+chartH);ctx.lineTo(x,padT+chartH);ctx.closePath();ctx.fill();
    } else if(barH>0){
      ctx.fillRect(x,y,barW,barH);
    }

    // X label (show subset)
    const showLabel=allDates.length<=14||i%Math.ceil(allDates.length/10)===0||i===allDates.length-1;
    if(showLabel){
      ctx.fillStyle='#555a6e';ctx.font='9px -apple-system,sans-serif';ctx.textAlign='center';ctx.textBaseline='top';
      ctx.fillText(fD(date),x+barW/2,padT+chartH+6);
    }
    // Value on top
    if(val>0&&(allDates.length<=20||val===maxVal)){
      ctx.fillStyle='#9498a8';ctx.font='bold 9px -apple-system,sans-serif';ctx.textAlign='center';ctx.textBaseline='bottom';
      ctx.fillText(val>=10000?Math.round(val/10000)+'ë§Œ':val>=1000?Math.round(val/1000)+'k':Math.round(val),x+barW/2,y-3);
    }
  });

  // Average line
  const avg=values.reduce((a,b)=>a+b,0)/values.length;
  const avgY=padT+chartH*(1-avg/maxVal);
  ctx.strokeStyle='rgba(248,113,113,0.6)';ctx.lineWidth=1;ctx.setLineDash([4,3]);
  ctx.beginPath();ctx.moveTo(padL,avgY);ctx.lineTo(W-padR,avgY);ctx.stroke();ctx.setLineDash([]);
  ctx.fillStyle='#f87171';ctx.font='bold 9px -apple-system,sans-serif';ctx.textAlign='left';ctx.textBaseline='bottom';
  ctx.fillText('í‰ê·  '+fK(avg),padL+4,avgY-3);
}

// ===== Edit Modal =====
let editingId=null,editPhotoData=null;
function openEdit(id){
  editingId=id;editPhotoData=null;editDeletePhoto=false;const e=getEntries().find(x=>x.id===id);if(!e)return;
  const[eh,em]=(e.time||'00:00').split(':');
  const allCats=new Set(['ì‹ì‚¬','êµí†µ','ì„ íƒê´€ê´‘','íŒ','ìˆ™ë°•','ì¬ë¬´ê´€ë¦¬','ê¸°íƒ€']);
  const allCurs=new Set(['EUR','USD','SEK','DKK','KRW']);
  const allPays=new Set(['ì¹´ë“œ','í˜„ê¸ˆ']);
  getEntries().forEach(x=>{if(x.category)allCats.add(x.category);if(x.currency)allCurs.add(x.currency);if(x.payment)allPays.add(x.payment);});
  const opts=(vals,cur)=>[...vals].map(v=>'<option '+(v===cur?'selected':'')+'>'+esc(v)+'</option>').join('');
  document.getElementById('modalBody').innerHTML=
    '<div class="fg"><label class="fl">í•­ëª©</label><input class="fi" id="e-title" value="'+esc(e.title)+'"></div>'+
    '<div class="frow"><div class="fg"><label class="fl">ë‚ ì§œ</label><input class="fi" type="date" id="e-date" value="'+(e.date||'')+'"></div>'+
    '<div class="fg"><label class="fl">ì‹œê°„</label><div class="time-row"><input class="time-field" id="e-hour" type="number" min="0" max="23" value="'+eh+'" inputmode="numeric"><span class="time-sep">:</span><input class="time-field" id="e-min" type="number" min="0" max="59" value="'+em+'" inputmode="numeric"></div></div></div>'+
    '<div class="frow"><div class="fg"><label class="fl">ì¹´í…Œê³ ë¦¬</label><select class="fi" id="e-cat"><option value="">ì„ íƒ</option>'+opts(allCats,e.category)+'</select></div>'+
    '<div class="fg"><label class="fl">í†µí™”</label><select class="fi" id="e-cur"><option value="">ì„ íƒ</option>'+opts(allCurs,e.currency)+'</select></div></div>'+
    '<div class="frow"><div class="fg"><label class="fl">ê¸ˆì•¡</label><input class="fi" type="number" id="e-amount" value="'+(e.amount||'')+'" step="0.01" inputmode="decimal"></div>'+
    '<div class="fg"><label class="fl">í™˜ìœ¨</label><input class="fi" type="number" id="e-rate" value="'+(e.rate||'')+'" step="0.01" inputmode="decimal"></div></div>'+
    '<div class="fg"><label class="fl">ê²°ì œìˆ˜ë‹¨</label><select class="fi" id="e-pay"><option value="">ì„ íƒ</option>'+opts(allPays,e.payment)+'</select></div>'+
    '<div class="fg"><label class="fl">ë©”ëª¨</label><textarea class="fi" id="e-memo" rows="2">'+esc(e.memo||'')+'</textarea></div>'+
    '<div class="fg"><label class="fl">ğŸ“ ì¥ì†Œ</label><div style="display:flex;gap:8px;align-items:center"><input class="fi" id="e-location" value="'+esc(e.location||'')+'" placeholder="ë„ì‹œëª…" style="flex:1"><button type="button" class="photo-btn" onclick="fetchEditLocation()" id="editLocBtn" style="white-space:nowrap;flex-shrink:0">ğŸ“ í˜„ì¬ ìœ„ì¹˜</button></div></div>'+
    '<div class="fg"><label class="fl">ğŸ“· ì˜ìˆ˜ì¦</label><div id="editPhotoArea"></div><div style="display:flex;gap:8px;margin-top:6px"><label class="photo-btn"><span>ğŸ“¸ ì‚¬ì§„ ë³€ê²½</span><input type="file" accept="image/*" style="display:none" onchange="handleEditPhoto(this)"></label><button class="photo-btn" onclick="removeEditPhoto()" id="editPhotoDelBtn" style="display:none;color:var(--red)">ğŸ—‘ ì‚¬ì§„ ì‚­ì œ</button></div></div>'+
    '<div class="fg" style="display:flex;align-items:center;gap:10px;margin-top:4px"><input type="checkbox" id="e-checked" '+(e.checked?'checked':'')+' style="width:20px;height:20px;accent-color:var(--accent)"><label for="e-checked" style="font-size:14px">í™•ì¸ ì™„ë£Œ</label></div>'+
    '<div class="modal-actions"><button class="btn-delete" onclick="deleteEntry()">ì‚­ì œ</button><button class="btn-save" onclick="updateEntry()">ì €ì¥</button></div>';
  if(e.photoId){getPhotoDB(e.photoId).then(d=>{if(d){document.getElementById('editPhotoArea').innerHTML='<img src="'+d+'" style="width:120px;height:90px;object-fit:cover;border-radius:8px;border:1px solid var(--border);cursor:pointer" onclick="viewPhoto(\''+e.photoId+'\')">';document.getElementById('editPhotoDelBtn').style.display='';}});}
  document.getElementById('editModal').classList.add('open');
}
let editDeletePhoto=false;
function removeEditPhoto(){editDeletePhoto=true;editPhotoData=null;document.getElementById('editPhotoArea').innerHTML='<span style="font-size:12px;color:var(--text2)">ì‚¬ì§„ ì‚­ì œë¨ (ì €ì¥ ì‹œ ë°˜ì˜)</span>';document.getElementById('editPhotoDelBtn').style.display='none';}
function handleEditPhoto(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();reader.onload=function(ev){
    const img=new Image();img.onload=function(){const c=document.createElement('canvas');const maxW=800;let w=img.width,h=img.height;if(w>maxW){h=Math.round(h*(maxW/w));w=maxW;}c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);editPhotoData=c.toDataURL('image/jpeg',0.7);editDeletePhoto=false;document.getElementById('editPhotoArea').innerHTML='<img src="'+editPhotoData+'" style="width:120px;height:90px;object-fit:cover;border-radius:8px;border:1px solid var(--border)">';document.getElementById('editPhotoDelBtn').style.display='';};img.src=ev.target.result;
  };reader.readAsDataURL(file);
}
function closeModal(){document.getElementById('editModal').classList.remove('open');editingId=null;editPhotoData=null;editDeletePhoto=false;}
async function fetchEditLocation(){
  const btn=document.getElementById('editLocBtn');
  const inp=document.getElementById('e-location');
  if(!navigator.geolocation){toast('ì´ ë¸Œë¼ìš°ì €ì—ì„œ GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');return;}
  btn.textContent='â³ ì¡°íšŒì¤‘...';btn.disabled=true;
  navigator.geolocation.getCurrentPosition(async pos=>{
    try{
      const lat=pos.coords.latitude,lon=pos.coords.longitude;
      const res=await fetch('https://nominatim.openstreetmap.org/reverse?lat='+lat+'&lon='+lon+'&format=json&accept-language=ko&zoom=14',{headers:{'User-Agent':'NordicExpenseApp/1.0'}});
      const data=await res.json();
      const addr=data.address||{};
      const detail=addr.suburb||addr.neighbourhood||addr.borough||addr.quarter||addr.district||addr.town_district||addr.village||addr.hamlet||addr.town||'';
      const city=addr.city||addr.town||addr.county||addr.state||'';
      const country=addr.country||'';
      let loc='';
      if(detail&&city&&detail!==city)loc=detail+', '+city;
      else if(city)loc=city;
      else if(detail)loc=detail;
      else loc=country;
      inp.value=loc;
      toast('ğŸ“ '+loc);
    }catch(e){toast('ìœ„ì¹˜ ë³€í™˜ ì‹¤íŒ¨');console.error(e);}
    btn.textContent='ğŸ“ í˜„ì¬ ìœ„ì¹˜';btn.disabled=false;
  },err=>{
    btn.textContent='ğŸ“ í˜„ì¬ ìœ„ì¹˜';btn.disabled=false;
    toast('ìœ„ì¹˜ ì¡°íšŒ ì‹¤íŒ¨');
  },{enableHighAccuracy:false,timeout:10000,maximumAge:300000});
}
async function updateEntry(){
  if(!editingId)return;const entries=getEntries();const idx=entries.findIndex(x=>x.id===editingId);if(idx===-1)return;
  const h=String(parseInt(document.getElementById('e-hour').value)||0).padStart(2,'0');
  const m=String(parseInt(document.getElementById('e-min').value)||0).padStart(2,'0');
  const cur=document.getElementById('e-cur').value;
  let photoId=entries[idx].photoId;
  if(editPhotoData){if(photoId)try{await deletePhotoDB(photoId);}catch(e){}photoId=genId()+'_p';try{await savePhotoDB(photoId,editPhotoData);}catch(e){}}
  else if(editDeletePhoto){if(photoId)try{await deletePhotoDB(photoId);}catch(e){}photoId=null;}
  entries[idx]={...entries[idx],title:document.getElementById('e-title').value.trim(),date:document.getElementById('e-date').value,time:h+':'+m,category:document.getElementById('e-cat').value,currency:cur,amount:parseFloat(document.getElementById('e-amount').value)||0,rate:cur==='KRW'?1:(parseFloat(document.getElementById('e-rate').value)||1),payment:document.getElementById('e-pay').value,memo:document.getElementById('e-memo').value.trim(),location:document.getElementById('e-location').value.trim(),photoId,checked:document.getElementById('e-checked').checked,updatedAt:new Date().toISOString()};
  setEntries(entries);closeModal();refreshAll();renderList();toast('âœ… ìˆ˜ì •ë¨');
}
async function deleteEntry(){
  if(!editingId||!confirm('ì´ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  const e=getEntries().find(x=>x.id===editingId);
  if(e?.photoId)try{await deletePhotoDB(e.photoId);}catch(err){}
  setEntries(getEntries().filter(x=>x.id!==editingId));closeModal();refreshAll();renderList();toast('ğŸ—‘ ì‚­ì œë¨');
}

// ===== CSV =====
function exportCSV(){
  const entries=getFilteredEntries(),s=getSettings();if(!entries.length){toast('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');return;}
  const h=['ë‚ ì§œ','ì‹œê°„','í•­ëª©','ì¹´í…Œê³ ë¦¬','í†µí™”','ê¸ˆì•¡','í™˜ìœ¨','ì›í™”í™˜ì‚°','ê²°ì œìˆ˜ë‹¨','ì¥ì†Œ','ë©”ëª¨','í™•ì¸','ì˜ìˆ˜ì¦'];
  const rows=entries.map(e=>[e.date,e.time,'"'+(e.title||'').replace(/"/g,'""')+'"',e.category,e.currency,e.amount||0,e.rate||'',Math.round(toKRW(e,s)),e.payment,'"'+(e.location||'').replace(/"/g,'""')+'"','"'+(e.memo||'').replace(/"/g,'""')+'"',e.checked?'Y':'N',e.photoId?'O':''].join(','));
  const csv='\uFEFF'+h.join(',')+'\n'+rows.join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'}));a.download='ê³µë™ê²½ë¹„_'+todayStr()+'.csv';a.click();toast('ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
}

// ===== JSON Backup =====
async function exportJSON(){
  toast('ğŸ“¦ ë°±ì—… ì¤€ë¹„ ì¤‘...');const photos=await getAllPhotos();
  const data={settings:getSettings(),entries:getEntries(),photos,exportedAt:new Date().toISOString()};
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(data)],{type:'application/json'}));a.download='ê³µë™ê²½ë¹„_ë°±ì—…_'+todayStr()+'.json';a.click();toast('ğŸ“¦ ë°±ì—… ì™„ë£Œ (ì‚¬ì§„ í¬í•¨)');
}
function importJSON(ev){
  const file=ev.target.files[0];if(!file)return;
  const r=new FileReader();r.onload=async function(e){
    try{const d=JSON.parse(e.target.result);if(!d.entries)throw 0;
      if(!confirm(d.entries.length+'ê±´ + ì‚¬ì§„ '+(d.photos||[]).length+'ì¥ì„ ë³µì›í•©ë‹ˆë‹¤.\nê¸°ì¡´ ë°ì´í„°ê°€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤. ê³„ì†?'))return;
      setEntries(d.entries);if(d.settings)setSettings(d.settings);
      if(d.photos)for(const p of d.photos){try{await savePhotoDB(p.id,p.data);}catch(err){}}
      refreshAll();closeSettings();toast('âœ… ë³µì› ì™„ë£Œ');
    }catch(err){toast('âŒ ì˜ëª»ëœ ë°±ì—… íŒŒì¼');}
  };r.readAsText(file);ev.target.value='';
}

// ===== Settings =====
function showSettings(){
  const s=getSettings();
  document.getElementById('s-fund').value=s.fund;
  document.getElementById('s-rate-EUR').value=s.rates.EUR||1500;
  document.getElementById('s-rate-USD').value=s.rates.USD||1450;
  document.getElementById('s-rate-SEK').value=s.rates.SEK||140;
  document.getElementById('s-rate-DKK').value=s.rates.DKK||210;
  document.getElementById('settingsModal').classList.add('open');
}
function closeSettings(){document.getElementById('settingsModal').classList.remove('open');}
function saveSettings(){
  const rates={...getSettings().rates,EUR:parseFloat(document.getElementById('s-rate-EUR').value)||1500,USD:parseFloat(document.getElementById('s-rate-USD').value)||1450,SEK:parseFloat(document.getElementById('s-rate-SEK').value)||140,DKK:parseFloat(document.getElementById('s-rate-DKK').value)||210,KRW:1};
  setSettings({fund:parseInt(document.getElementById('s-fund').value)||5400000,rates});
  closeSettings();refreshAll();toast('âœ… ì„¤ì • ì €ì¥ë¨');
}
function confirmReset(){
  if(!confirm('âš ï¸ ëª¨ë“  ì§€ì¶œ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.\nì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  if(!confirm('ë§ˆì§€ë§‰ í™•ì¸: ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'))return;
  localStorage.removeItem(SK);localStorage.removeItem(SSK);indexedDB.deleteDatabase(DB_NAME);refreshAll();toast('ğŸ—‘ ì´ˆê¸°í™” ì™„ë£Œ');
}

function toast(msg){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2000);}
document.getElementById('editModal').addEventListener('click',function(ev){if(ev.target===this)closeModal();});
document.getElementById('settingsModal').addEventListener('click',function(ev){if(ev.target===this)closeSettings();});
openDB().catch(e=>console.warn('IndexedDB:',e));
</script>
</body>
</html>
